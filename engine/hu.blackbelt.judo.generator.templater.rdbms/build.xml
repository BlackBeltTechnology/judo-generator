<?xml version="1.0" encoding="UTF-8"?>
<project default="main">

	<property name="third.party.project.dir" location="../hu.blackbelt.judo.generator.third.party" />

	<!-- ANT Taskdefs for ant-contrib -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
	 <classpath>
	    <pathelement location="${third.party.project.dir}/lib/ant/contrib/ant-contrib.jar"/>
	  </classpath>
	</taskdef>

	<property name="model.file.extension" value="model" />

	<property name="root.dir" location="." />
	<property name="_src.dir" location="${root.dir}/src" />
	<property name="target.dir.name" value="target-ant" />
	<property name="target.dir" location="${target.dir.name}" />

	<path id="ant.taskdef.classpath">
		<fileset dir="${third.party.project.dir}/lib/ant" includes="**/*.jar" />
	</path>
	
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="ant.taskdef.classpath" />
	<taskdef resource="org/eclipse/epsilon/workflow/tasks/tasks.xml" classpathref="ant.taskdef.classpath" loaderref="epsilon.loader" />
	<taskdef resource="org/eclipse/epsilon/workflow/tasks/emf/tasks.xml"  loaderref="epsilon.loader" />

	<property name="templates.dir" location="${_src.dir}/templates" />

	<!-- =========================== -->
	<!-- Project specific parameters -->
	<!-- =========================== -->
	<property name="sqlDialects" value="Postgres"/>
	<property name="meta.psm.rdbms.project.dir" location="../hu.blackbelt.judo.generator.meta.psm.rdbms" />
	<property name="rdbms.psm.library.dir" location="${meta.psm.rdbms.project.dir}/library" />
	<property name="gen.dir" location="${target.dir}/rdbms" />
	<property name="rdbms.psm.templater.entry" location="${_src.dir}/main.egl" />

	
	<!-- RDBMS Model -->
	<property name="rdbms.psm.model.project.dir" value="../hu.blackbelt.judo.generator.transformer.rdbms" />
	<property name="rdbms.psm.model.name" value="RDBMS" />
	<property name="rdbms.psm.model.location.prefix" location="${rdbms.psm.model.project.dir}/target-ant/resources/rdbms_psm" />
	<property name="rdbms.psm.meta.location" location="${meta.psm.rdbms.project.dir}/model/rdbms.ecore" />
	<property name="rdbms.psm.meta.uri" value="http://blackbelt.hu/judo/meta/psm/rdbms" />

	<target name="prepare">
		<delete dir="${gen.dir}" failonerror="false" />
		<mkdir dir="${gen.dir}/rdbms" />
		<mkdir dir="${target.dir}" />
		<mkdir dir="${gen.dir}" />
	</target>

	<target name="prepareForMaven">
		<mkdir dir="${transformed.dir}" />
	</target>

	<target name="loadModels">
		<epsilon.emf.register file="${rdbms.psm.meta.location}" />
		<epsilon.emf.loadModel name="${rdbms.psm.model.name}" modelfile="${rdbms.psm.model.location.prefix}${sqlDialect}.${model.file.extension}" metamodeluri="${rdbms.psm.meta.uri}" read="true" store="false" expand="true" />
	</target>

	<target name="generate" depends="loadModels">
		<epsilon.egl src="${rdbms.psm.templater.entry}" outputRoot="${gen.dir}">
			<model ref="${rdbms.psm.model.name}" />
		</epsilon.egl>
	</target>


	<!-- Dialect specific calls -->
	<target name="mainFromMaven">
		<foreach list="${sqlDialects}" param="sqlDialect" target="mainFromMavenForDialect"/>
	</target>

	<target name="mainFromCommandLine">
		<foreach list="${sqlDialects}" param="sqlDialect" target="mainFromCommandLineForDialect"/>
	</target>

	<target name="main" depends="prepare">
		<foreach list="${sqlDialects}" param="sqlDialect" target="mainForDialect"/>
	</target>

	<target name="pre" depends="prepare">
		<foreach list="${sqlDialects}" param="sqlDialect" target="preForDialect"/>
	</target>

	<target name="executeGenerate">
		<foreach list="${sqlDialects}" param="sqlDialect" target="generate"/>
	</target>

	<target name="mainFromMavenForDialect" depends="prepareForMaven, loadModels, generate" />
	<target name="mainFromCommandLineForDialect" depends="prepare, loadModels, generate" />
	<target name="mainForDialect" depends="generate"/>
	<target name="preForDialect" depends="loadModels"/>

</project>